<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocaMaster - TOEFL Flashcards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background-color: #f0f4f8; overflow-x: hidden; }
        .card-container { perspective: 1000px; }
        .card { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.6s; }
        .card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 1.5rem; border-radius: 1.5rem; }
        .card-front { background-color: #ffffff; color: #1e293b; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 2; }
        .card-back { background-color: #4f46e5; color: white; transform: rotateY(180deg); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 1; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        #sidebar.open { transform: translateX(0); }
        #sidebar.closed { transform: translateX(-100%); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col relative">

    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h2 class="text-xl font-bold mb-4">ë™ê¸°í™” ID ì…ë ¥</h2>
            <p class="text-gray-600 text-sm mb-4">PCì™€ ëª¨ë°”ì¼ì—ì„œ ë™ì¼í•œ IDë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p>
            <input type="text" id="sync-id-input" placeholder="ì˜ˆ: my-voca-01" class="w-full border p-2 rounded mb-4">
            <button onclick="saveSyncId()" class="w-full bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-white shadow-2xl z-40 closed overflow-y-auto p-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">ë‹¨ì–´ ëª©ë¡</h2>
            <button onclick="toggleSidebar()" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div id="sidebar-content" class="space-y-4"></div>
    </div>

    <header class="w-full bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-20">
        <button onclick="toggleSidebar()" class="text-slate-600 text-xl p-2"><i class="fas fa-bars"></i></button>
        <h1 class="text-lg md:text-xl font-bold text-slate-800">VocaMaster</h1>
        <div class="w-8"></div>
    </header>

    <main class="flex-grow flex flex-col items-center justify-start p-4 w-full max-w-2xl mx-auto mt-4">
        
        <div class="w-full bg-white rounded-xl p-4 shadow-sm mb-6">
            <div class="flex flex-wrap gap-2 justify-center mb-4">
                <span class="text-xs font-bold text-gray-500 self-center mr-2">ë³´ê¸°:</span>
                <button onclick="setFilter('all')" id="btn-filter-all" class="px-3 py-1 text-sm rounded-full bg-indigo-600 text-white transition">ì „ì²´</button>
                <button onclick="setFilter('unknown')" id="btn-filter-unknown" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 transition">ğŸ”´ ëª»ì™¸ì›€</button>
                <button onclick="setFilter('ambiguous')" id="btn-filter-ambiguous" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 transition">ğŸŸ¡ ì• ë§¤í•¨</button>
                <button onclick="setFilter('memorized')" id="btn-filter-memorized" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 transition">ğŸŸ¢ ì™¸ì›€</button>
            </div>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 text-sm text-gray-700 bg-gray-50 p-2 rounded-lg select-none">
                <label class="flex items-center cursor-pointer hover:text-indigo-600 transition">
                    <input type="checkbox" id="shuffle-toggle" class="mr-2 w-4 h-4 text-indigo-600" onchange="toggleShuffle()">
                    <span>ğŸ”€ ìˆœì„œ ì„ê¸°</span>
                </label>
                <div class="hidden sm:block w-px h-4 bg-gray-300"></div>
                <label class="flex items-center cursor-pointer hover:text-indigo-600 transition">
                    <input type="checkbox" id="reverse-mode-toggle" class="mr-2 w-4 h-4 text-indigo-600" onchange="toggleViewOptions()">
                    <span>ğŸ‡°ğŸ‡· ëœ» ë¨¼ì €</span>
                </label>
                <div class="hidden sm:block w-px h-4 bg-gray-300"></div>
                <label class="flex items-center cursor-pointer hover:text-indigo-600 transition">
                    <input type="checkbox" id="english-def-toggle" class="mr-2 w-4 h-4 text-indigo-600" onchange="toggleViewOptions()">
                    <span>ğŸ‡ºğŸ‡¸ ì˜ì–´ ëœ»</span>
                </label>
            </div>
        </div>

        <div class="card-container h-80 w-full mb-4 cursor-pointer relative" onclick="flipCard()">
            <div id="card" class="card w-full h-full">
                <div class="card-face card-front relative">
                    <span id="card-difficulty" class="absolute top-4 right-4 text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-500">...</span>
                    <span id="card-part" class="absolute top-4 left-4 text-xs italic text-gray-400">...</span>
                    <h2 id="card-front-text" class="text-4xl font-bold break-keep px-2">Loading...</h2>
                </div>
                <div class="card-face card-back">
                    <h2 id="card-back-main" class="text-3xl font-bold mb-4 break-keep px-2">ë¡œë”© ì¤‘</h2>
                    <p id="card-back-sub" class="text-base font-medium opacity-90 break-keep px-4">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <div id="example-area" class="w-full bg-indigo-50 rounded-lg p-4 mb-6 hidden transition-all">
            <p class="text-indigo-900 font-medium text-center italic">"<span id="example-text"></span>"</p>
        </div>
        <button onclick="toggleExample()" class="text-indigo-600 text-sm font-semibold mb-6 hover:underline">
            <i class="far fa-eye mr-1"></i> ì˜ˆë¬¸ ë³´ê¸° / ìˆ¨ê¸°ê¸°
        </button>

        <div class="grid grid-cols-3 gap-3 w-full mb-8">
            <button onclick="updateStatus('unknown')" id="btn-status-unknown" class="p-3 rounded-lg border-2 border-red-100 text-red-600 font-bold transition flex flex-col items-center justify-center text-sm md:text-base hover:bg-red-50">
                <span>ğŸ”´</span><span>ëª°ë¼ìš”</span>
            </button>
            <button onclick="updateStatus('ambiguous')" id="btn-status-ambiguous" class="p-3 rounded-lg border-2 border-yellow-100 text-yellow-600 font-bold transition flex flex-col items-center justify-center text-sm md:text-base hover:bg-yellow-50">
                <span>ğŸŸ¡</span><span>ì• ë§¤í•´ìš”</span>
            </button>
            <button onclick="updateStatus('memorized')" id="btn-status-memorized" class="p-3 rounded-lg border-2 border-green-100 text-green-600 font-bold transition flex flex-col items-center justify-center text-sm md:text-base hover:bg-green-50">
                <span>ğŸŸ¢</span><span>ì™¸ì› ì–´ìš”</span>
            </button>
        </div>

        <div class="flex items-center justify-center space-x-6 mb-8">
            <button onclick="prevCard()" class="w-12 h-12 rounded-full bg-white shadow text-gray-600 hover:bg-gray-50 active:scale-95 transition"><i class="fas fa-chevron-left"></i></button>
            <span id="card-counter" class="text-gray-500 font-mono">0 / 0</span>
            <button onclick="nextCard()" class="w-12 h-12 rounded-full bg-indigo-600 shadow text-white hover:bg-indigo-700 active:scale-95 transition"><i class="fas fa-chevron-right"></i></button>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ==========================================
        // [í•„ìˆ˜] Firebase ì„¤ì •ê°’ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAoLwWDvszFSxKxrrRgts2sxhKtmalAm94",
            authDomain: "my-toefl-voca.firebaseapp.com",
            projectId: "my-toefl-voca",
            storageBucket: "my-toefl-voca.firebasestorage.app",
            messagingSenderId: "929048950334",
            appId: "1:929048950334:web:d33177785663a9dd22c36f",
            databaseURL: "https://my-toefl-voca-default-rtdb.asia-southeast1.firebasedatabase.app",
            measurementId: "G-TVDZVQJECG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.ref = ref;
        window.set = set;
        window.onValue = onValue;
        
        loadVocabulary();
    </script>

    <script>
        let rawVocabulary = []; 
        let userSyncId = localStorage.getItem('voca_sync_id');
        let statusData = {}; 
        let currentList = []; 
        let currentIndex = 0;
        let currentFilter = 'all'; 
        let isReverseMode = false;
        let isEnglishDefMode = false;
        let isShuffleMode = false; // ì…”í”Œ ëª¨ë“œ ìƒíƒœ

        // --- 1. ë°ì´í„° ë¡œë“œ ---
        async function loadVocabulary() {
            try {
                const response = await fetch('words.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                rawVocabulary = await response.json();
                console.log("ë‹¨ì–´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", rawVocabulary.length + "ê°œ");
                initApp();
            } catch (error) {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                document.getElementById('card-front-text').innerText = "ë°ì´í„° ì˜¤ë¥˜";
                document.getElementById('card-back-main').innerText = "words.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                if(window.location.protocol === 'file:') {
                    alert("ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì‹œ Live Serverë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                }
            }
        }

        // --- 2. ì´ˆê¸°í™” ---
        function initApp() {
            if (!userSyncId) {
                document.getElementById('login-modal').classList.remove('hidden');
            } else {
                startSync();
            }
        }

        window.saveSyncId = function() {
            const input = document.getElementById('sync-id-input').value.trim();
            if(input) {
                userSyncId = input;
                localStorage.setItem('voca_sync_id', input);
                document.getElementById('login-modal').classList.add('hidden');
                startSync();
            } else {
                alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        }

        function startSync() {
            const starCountRef = window.ref(window.db, 'users/' + userSyncId);
            window.onValue(starCountRef, (snapshot) => {
                const data = snapshot.val();
                statusData = data || {}; 
                // ë°ì´í„°ê°€ ì²˜ìŒ ë¡œë“œë  ë•ŒëŠ” í•„í„°ë¥¼ ì ìš©í•˜ì§€ë§Œ,
                // ì´ë¯¸ ë³´ê³  ìˆëŠ” ìƒíƒœ(currentIndex > 0)ë¼ë©´ ë°©í•´í•˜ì§€ ì•Šë„ë¡ ì¡°ê±´ë¶€ ì²˜ë¦¬ ê°€ëŠ¥.
                // í•˜ì§€ë§Œ ë‹¨ìˆœí•¨ì„ ìœ„í•´ ì—¬ê¸°ì„  ë°ì´í„° ë™ê¸°í™” ì‹œ ë¦¬ìŠ¤íŠ¸ ê°±ì‹  (ë‹¨, í•„í„°ì™€ ì…”í”Œ ìœ ì§€)
                
                // ë§Œì•½ ì‚¬ìš©ìê°€ í•™ìŠµ ì¤‘ì´ë¼ë©´ ë¦¬ìŠ¤íŠ¸ ì „ì²´ ë¦¬ì…‹ì€ UXì— ì¢‹ì§€ ì•ŠìŒ.
                // ì—¬ê¸°ì„œëŠ” ì‚¬ì´ë“œë°”ë§Œ ê°±ì‹ í•˜ê³ , ë©”ì¸ ë¦¬ìŠ¤íŠ¸ëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ì¡°ì‘í•  ë•Œ(í•„í„° ë³€ê²½ ë“±)ë§Œ ê°±ì‹ í•˜ëŠ” ê²ƒì´ ë‚˜ì„ ìˆ˜ë„ ìˆìœ¼ë‚˜,
                // ë™ê¸°í™”ë¥¼ ìœ„í•´ ìµœì´ˆ 1íšŒëŠ” ë¬´ì¡°ê±´ ì‹¤í–‰.
                if(currentList.length === 0) {
                    applyFilter();
                } else {
                    renderSidebar();
                    // í˜„ì¬ ë³´ê³  ìˆëŠ” ì¹´ë“œì˜ ìƒíƒœ ë²„íŠ¼ë§Œ ì—…ë°ì´íŠ¸
                    if(currentList[currentIndex]) {
                        const word = currentList[currentIndex].Word;
                        const newStatus = statusData[word] || 'unknown';
                        currentList[currentIndex].status = newStatus; // ë©”ëª¨ë¦¬ ìƒ ìƒíƒœ ì—…ë°ì´íŠ¸
                        updateStatusButtons(newStatus);
                    }
                }
            });
        }

        // --- í•„í„° ë° ì…”í”Œ ë¡œì§ ---
        window.setFilter = function(filterType) {
            currentFilter = filterType;
            ['all', 'unknown', 'ambiguous', 'memorized'].forEach(t => {
                const btn = document.getElementById(`btn-filter-${t}`);
                if(t === filterType) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-indigo-600', 'text-white');
                } else {
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                    btn.classList.remove('bg-indigo-600', 'text-white');
                }
            });
            applyFilter(); // í•„í„° ë°”ê¿€ ë• ë¦¬ìŠ¤íŠ¸ ë¦¬ì…‹ (ì¸ë±ìŠ¤ 0ìœ¼ë¡œ)
        }

        window.toggleShuffle = function() {
            isShuffleMode = document.getElementById('shuffle-toggle').checked;
            applyFilter(); // ì…”í”Œ ëª¨ë“œ ë°”ë€Œë©´ ë¦¬ìŠ¤íŠ¸ ë¦¬ì…‹ ë° ì„ê¸°
        }

        // Fisher-Yates Shuffle
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function applyFilter() {
            if(rawVocabulary.length === 0) return;

            // 1. ìƒíƒœ ë³‘í•©
            let combinedData = rawVocabulary.map(item => {
                const status = statusData[item.Word] || 'unknown';
                return { ...item, status: status };
            });

            // 2. í•„í„°ë§
            if (currentFilter !== 'all') {
                combinedData = combinedData.filter(item => item.status === currentFilter);
            }

            // 3. ì •ë ¬ í˜¹ì€ ì…”í”Œ
            if (isShuffleMode) {
                // ì…”í”Œ ëª¨ë“œë©´ ì„ê¸°
                currentList = shuffleArray([...combinedData]);
            } else {
                // ì•„ë‹ˆë©´ ì›ë˜ ìˆœì„œ(JSON ìˆœì„œ)ëŒ€ë¡œ
                // combinedDataëŠ” ì´ë¯¸ rawVocabulary ìˆœì„œë¥¼ ë”°ë¥´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë‘ 
                currentList = combinedData;
            }

            // 4. ì¸ë±ìŠ¤ ì´ˆê¸°í™” ë° ë Œë”ë§
            currentIndex = 0;
            if (currentList.length === 0) renderEmpty();
            else renderCard();
        }

        window.toggleViewOptions = function() {
            isReverseMode = document.getElementById('reverse-mode-toggle').checked;
            isEnglishDefMode = document.getElementById('english-def-toggle').checked;
            renderCard();
        }

        // --- ë Œë”ë§ ---
        function renderCard() {
            if(currentList.length === 0) return;
            const item = currentList[currentIndex];
            
            const word = item.Word;
            const korDef = item['Korean Definition'];
            const engDef = item['English Definition'];
            
            let frontText, backMain, backSub;

            if (!isReverseMode) {
                frontText = word;
                backMain = !isEnglishDefMode ? korDef : engDef;
                backSub = !isEnglishDefMode ? engDef : korDef;
            } else {
                frontText = !isEnglishDefMode ? korDef.split(',')[0] : engDef;
                backMain = word;
                backSub = !isEnglishDefMode ? engDef : korDef;
            }

            document.getElementById('card-difficulty').innerText = item.Difficulty ? item.Difficulty.toUpperCase() : '';
            document.getElementById('card-part').innerText = item['Part of Speech'] || '';
            document.getElementById('example-text').innerText = item['Example Sentence'] || '';
            document.getElementById('card-front-text').innerText = frontText;
            document.getElementById('card-back-main').innerText = backMain;
            document.getElementById('card-back-sub').innerText = backSub;

            document.getElementById('card-counter').innerText = `${currentIndex + 1} / ${currentList.length}`;
            updateStatusButtons(item.status);
        }

        function renderEmpty() {
            document.getElementById('card-front-text').innerText = "ì™„ë£Œ/ì—†ìŒ";
            document.getElementById('card-back-main').innerText = "ì´ í•„í„°ì—ëŠ” ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.";
            document.getElementById('card-back-sub').innerText = "ë‹¤ë¥¸ í•„í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
            document.getElementById('card-counter').innerText = "0 / 0";
            
            ['unknown', 'ambiguous', 'memorized'].forEach(status => {
                const btn = document.getElementById(`btn-status-${status}`);
                btn.className = "p-3 rounded-lg border-2 border-gray-200 text-gray-300 font-bold flex flex-col items-center justify-center text-sm md:text-base cursor-not-allowed";
            });
        }

        function updateStatusButtons(currentStatus) {
            const btns = {
                unknown: document.getElementById('btn-status-unknown'),
                ambiguous: document.getElementById('btn-status-ambiguous'),
                memorized: document.getElementById('btn-status-memorized')
            };

            // Reset
            btns.unknown.className = "p-3 rounded-lg border-2 border-red-100 text-red-600 font-bold transition flex flex-col items-center justify-center text-sm md:text-base hover:bg-red-50";
            btns.ambiguous.className = "p-3 rounded-lg border-2 border-yellow-100 text-yellow-600 font-bold transition flex flex-col items-center justify-center text-sm md:text-base hover:bg-yellow-50";
            btns.memorized.className = "p-3 rounded-lg border-2 border-green-100 text-green-600 font-bold transition flex flex-col items-center justify-center text-sm md:text-base hover:bg-green-50";

            // Active
            if(currentStatus === 'unknown') {
                btns.unknown.className = "p-3 rounded-lg border-2 border-red-500 bg-red-500 text-white font-bold transition flex flex-col items-center justify-center text-sm md:text-base shadow-md transform scale-105";
            } else if(currentStatus === 'ambiguous') {
                btns.ambiguous.className = "p-3 rounded-lg border-2 border-yellow-400 bg-yellow-400 text-white font-bold transition flex flex-col items-center justify-center text-sm md:text-base shadow-md transform scale-105";
            } else if(currentStatus === 'memorized') {
                btns.memorized.className = "p-3 rounded-lg border-2 border-green-500 bg-green-500 text-white font-bold transition flex flex-col items-center justify-center text-sm md:text-base shadow-md transform scale-105";
            }
        }

        // --- ì¸í„°ë™ì…˜ ë° ìƒíƒœ ì—…ë°ì´íŠ¸ (í•µì‹¬ ìˆ˜ì •) ---
        window.flipCard = function() { document.getElementById('card').classList.toggle('flipped'); }
        window.toggleExample = function() { document.getElementById('example-area').classList.toggle('hidden'); }
        
        window.nextCard = function() { 
            if (currentList.length === 0) return; 
            currentIndex = (currentIndex + 1) % currentList.length; 
            resetCardState();
            renderCard(); 
        }
        
        window.prevCard = function() { 
            if (currentList.length === 0) return; 
            currentIndex = (currentIndex - 1 + currentList.length) % currentList.length; 
            resetCardState();
            renderCard(); 
        }

        function resetCardState() {
            document.getElementById('card').classList.remove('flipped'); 
            document.getElementById('example-area').classList.add('hidden');
        }

        window.updateStatus = function(newStatus) {
            if (currentList.length === 0) return;
            const currentItem = currentList[currentIndex];
            const word = currentItem.Word;

            // 1. Firebase ì €ì¥
            statusData[word] = newStatus;
            window.set(window.ref(window.db, 'users/' + userSyncId + '/' + word), newStatus)
                .catch((error) => alert("ì˜¤ë¥˜: " + error.message));
            
            // 2. UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë²„íŠ¼ ìƒ‰ìƒ ë“±)
            updateStatusButtons(newStatus);
            renderSidebar();

            // 3. [ì¤‘ìš”] ë„¤ë¹„ê²Œì´ì…˜ ë¡œì§ ìˆ˜ì •
            // ë¦¬ìŠ¤íŠ¸ ì „ì²´ë¥¼ ê°±ì‹ (applyFilter)í•˜ë©´ ë§¨ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ë²„ë¦¼.
            // ë”°ë¼ì„œ í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ë©”ëª¨ë¦¬ ìƒì—ì„œë§Œ ì²˜ë¦¬í•˜ê³  ë‹¤ìŒ ì¹´ë“œë¡œ ë„˜ê¹€.
            
            if (currentFilter === 'all' || currentFilter === newStatus) {
                // A. í˜„ì¬ í•„í„°ì—ì„œë„ ì—¬ì „íˆ ë³´ì—¬ì•¼ í•˜ëŠ” ê²½ìš° (ì˜ˆ: 'ì „ì²´' ë³´ê¸° ì¤‘ì´ê±°ë‚˜, ìƒíƒœê°€ ì•ˆ ë°”ë€œ)
                // ê·¸ëƒ¥ ë‹¤ìŒ ì¹´ë“œë¡œ ë„˜ì–´ê°„ë‹¤.
                setTimeout(() => nextCard(), 200);
            } else {
                // B. í˜„ì¬ í•„í„°ì—ì„œ ì‚¬ë¼ì ¸ì•¼ í•˜ëŠ” ê²½ìš° (ì˜ˆ: 'ëª»ì™¸ì›€' ë³´ê¸°ì—ì„œ 'ì™¸ì›€' ëˆ„ë¦„)
                // ë¦¬ìŠ¤íŠ¸ì—ì„œ í˜„ì¬ í•­ëª©ì„ ì œê±°í•˜ê³ , ì¸ë±ìŠ¤ëŠ” ìœ ì§€(í•˜ë©´ ë’¤ì— ìˆë˜ê²Œ ì•ìœ¼ë¡œ ì˜´)
                currentList.splice(currentIndex, 1);
                
                // ì¸ë±ìŠ¤ ë³´ì • (ë§ˆì§€ë§‰ ì¹´ë“œë¥¼ ì§€ì› ì„ ê²½ìš°)
                if (currentIndex >= currentList.length) {
                    currentIndex = Math.max(0, currentList.length - 1);
                }

                if (currentList.length === 0) {
                    renderEmpty();
                } else {
                    // ì¹´ë“œê°€ ì‚¬ë¼ì§€ëŠ” ëŠë‚Œì„ ìœ„í•´ ì‚´ì§ ë”œë ˆì´ í›„ ë Œë”ë§
                    setTimeout(() => {
                        resetCardState();
                        renderCard();
                    }, 200);
                }
            }
        }

        // --- ì‚¬ì´ë“œë°” ---
        window.toggleSidebar = function() {
            const sb = document.getElementById('sidebar');
            const ol = document.getElementById('sidebar-overlay');
            if (sb.classList.contains('closed')) {
                sb.classList.remove('closed'); sb.classList.add('open');
                ol.classList.remove('hidden');
                renderSidebar();
            } else {
                sb.classList.remove('open'); sb.classList.add('closed');
                ol.classList.add('hidden');
            }
        }

        window.renderSidebar = function() {
            const container = document.getElementById('sidebar-content');
            container.innerHTML = '';
            const groups = { unknown: [], ambiguous: [], memorized: [] };
            
            if(rawVocabulary.length === 0) return;

            rawVocabulary.forEach(item => {
                const st = statusData[item.Word] || 'unknown';
                if(groups[st]) groups[st].push(item);
            });
            
            const labels = { unknown: 'ğŸ”´ ëª»ì™¸ì›€', ambiguous: 'ğŸŸ¡ ì• ë§¤í•¨', memorized: 'ğŸŸ¢ ì™¸ì›€' };
            for (const [key, list] of Object.entries(groups)) {
                const details = document.createElement('details');
                details.open = true;
                const summary = document.createElement('summary');
                summary.className = "cursor-pointer font-bold text-gray-700 py-2 select-none list-none flex items-center hover:bg-gray-50 rounded px-2";
                summary.innerHTML = `<span class="mr-2 text-xs">â–¼</span> ${labels[key]} <span class="ml-auto text-xs bg-gray-200 px-2 py-0.5 rounded-full text-gray-600">${list.length}</span>`;
                const ul = document.createElement('ul');
                ul.className = "pl-2 space-y-1 mt-1 mb-4";
                if (list.length === 0) {
                    const emptyLi = document.createElement('li');
                    emptyLi.className = "text-xs text-gray-400 pl-4 py-1";
                    emptyLi.innerText = "(ì—†ìŒ)";
                    ul.appendChild(emptyLi);
                } else {
                    list.forEach(wordItem => {
                        const li = document.createElement('li');
                        li.className = "text-sm text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 cursor-pointer py-1.5 px-2 rounded truncate transition";
                        li.innerText = `${wordItem.Word}`;
                        li.onclick = () => jumpToWord(wordItem.Word);
                        ul.appendChild(li);
                    });
                }
                details.appendChild(summary); details.appendChild(ul); container.appendChild(details);
            }
        }

        function jumpToWord(word) {
            if (currentFilter !== 'all') {
                // ë‹¤ë¥¸ í•„í„°ì— ìˆëŠ” ë‹¨ì–´ë¡œ ì í”„í•˜ë ¤ë©´ ì „ì²´ í•„í„°ë¡œ ê°€ì•¼ í•¨
                // í•„í„°ë¥¼ ë°”ê¾¸ë©´ ë¦¬ìŠ¤íŠ¸ê°€ ì¬ìƒì„±ë˜ë¯€ë¡œ(applyFilter í˜¸ì¶œ), ì—¬ê¸°ì„œ ì¸ë±ìŠ¤ë¥¼ ì°¾ì•„ì•¼ í•¨
                document.getElementById('btn-filter-all').click(); 
                // setFilter -> applyFilter ì‹¤í–‰ ì™„ë£Œë¨ (ë™ê¸°ì )
            }
            
            const targetIndex = currentList.findIndex(item => item.Word === word);
            if (targetIndex !== -1) {
                currentIndex = targetIndex;
                resetCardState();
                renderCard();
                if(window.innerWidth < 768) toggleSidebar();
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowRight') nextCard();
            else if(e.key === 'ArrowLeft') prevCard();
            else if(e.key === ' ' || e.key === 'Enter') { e.preventDefault(); flipCard(); }
        });

        window.resetAllToUnknown = function() {
            if(!confirm("ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const updates = {};
            rawVocabulary.forEach(item => {
                updates[item.Word] = 'unknown';
            });
            window.set(window.ref(window.db, 'users/' + userSyncId), updates)
                .then(() => alert("ì´ˆê¸°í™” ì™„ë£Œ!"));
        };
    </script>
</body>
</html>